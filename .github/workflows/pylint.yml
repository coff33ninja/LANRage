name: Pylint

on: 
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  pylint:
    name: Pylint Analysis
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12", "3.13"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    
    - name: Create virtual environment
      run: uv venv --python ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        source .venv/bin/activate
        uv pip install -r requirements.txt
    
    - name: Analysing the code with pylint
      run: |
        source .venv/bin/activate
        echo "ðŸ” Running Pylint analysis..."
        # Pylint exit codes: 0=no issues, 4=warnings, 8+=errors
        # We accept warnings (exit 4) but fail on errors (exit 8+)
        pylint $(git ls-files '*.py') --output-format=colorized --score=yes || EXIT_CODE=$?
        if [ "${EXIT_CODE:-0}" -ge 8 ]; then
          echo "âŒ Pylint found errors (exit code: $EXIT_CODE)"
          exit $EXIT_CODE
        elif [ "${EXIT_CODE:-0}" -eq 4 ]; then
          echo "âš ï¸  Pylint found warnings but continuing (exit code: 4)"
        else
          echo "âœ… Pylint passed with no issues"
        fi
    
    - name: Generate Pylint report
      if: always()
      run: |
        source .venv/bin/activate
        pylint $(git ls-files '*.py') --output-format=json > pylint-report-${{ matrix.python-version }}.json || true
    
    - name: Upload Pylint report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pylint-report-${{ matrix.python-version }}
        path: pylint-report-${{ matrix.python-version }}.json
    
    - name: Check Pylint score
      run: |
        source .venv/bin/activate
        SCORE=$(pylint $(git ls-files '*.py') --score=yes 2>&1 | grep "Your code has been rated at" | awk '{print $7}' | cut -d'/' -f1)
        echo "ðŸ“Š Pylint Score: $SCORE/10.00"
        if (( $(echo "$SCORE < 9.0" | bc -l) )); then
          echo "âš ï¸  Warning: Pylint score below 9.0"
        else
          echo "âœ… Excellent code quality!"
        fi
